{
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workbookDisplayName": {
      "type": "string",
      "defaultValue": "OMI Vulnerability Workbook",
      "metadata": {
        "description": "The friendly name for the workbook that is used in the Gallery or Saved List.  This name must be unique within a resource group."
      }
    },
    "workbookType": {
      "type": "string",
      "defaultValue": "workbook",
      "metadata": {
        "description": "The gallery that the workbook will been shown under. Supported values include workbook, tsg, etc. Usually, this is 'workbook'"
      }
    },
    "workbookSourceId": {
      "type": "string",
      "defaultValue": "azure security center",
      "metadata": {
        "description": "The id of resource instance to which the workbook will be associated"
      }
    },
    "workbookId": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "The unique guid for this workbook instance"
      }
    }
  },
  "variables": {
    "workbookContent": {
      "version": "Notebook/1.0",
      "items": [
        {
          "type": 1,
          "content": {
            "json": "## OMI Vulnerability\r\nAzure open management infrastructure (OMI) is an open-source web-based implementation for managing Linux and UNIX machines. Azure virtual machines use this framework to orchestrate configuration management and log collection on Linux VMs.\r\n## How can an attacker exploit the vulnerability?\r\nThe OMI internal process communication is authenticated by using a key that consists of a random number. The method used to generate the random number can be spoofed by an attacker to manipulate the OMI communications to gain elevated privileges.  The attacker must be locally logged in to the machine on which the OMI components are running.\r\nPlease find remediation guidance in the following [link:](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-29149) \r\n## How can I determine which VMs are impacted by this vulnerability?\r\nUse this workbook to find machines at risk from this specific vulnerability. The workbook shows resources from your Azure, hybrid and multi-cloud environment. \r\nCVE data comes from Defender for Cloudâ€™s integrated vulnerability assessment solution (TVM and Qualys). \r\n"
          },
          "name": "Headline"
        },
        {
          "type": 9,
          "content": {
            "version": "KqlParameterItem/1.0",
            "parameters": [
              {
                "id": "206f87e8-2616-4d26-a94f-a97eb4cee619",
                "version": "KqlParameterItem/1.0",
                "name": "Subscription",
                "type": 6,
                "description": "Select one or more subscriptions from this list to show the relevant data.",
                "isRequired": true,
                "multiSelect": true,
                "quote": "'",
                "delimiter": ",",
                "typeSettings": {
                  "additionalResourceOptions": [
                    "value::all"
                  ],
                  "includeAll": true,
                  "showDefault": false
                },
                "timeContext": {
                  "durationMs": 86400000
                },
                "defaultValue": "value::all",
                "value": [
                  "value::all"
                ]
              }
            ],
            "style": "pills",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces"
          },
          "name": "Parameters"
        },
        {
          "type": 12,
          "content": {
            "version": "NotebookGroup/1.0",
            "groupType": "editable",
            "loadType": "always",
            "items": [
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "securityresources\r\n| where type == \"microsoft.security/assessments/subassessments\"\r\n| extend assessmentKey = extract(\".*assessments/(.+?)/.*\",1, id)\r\n| where assessmentKey == \"1195afff-c881-495e-9bc5-1486211ae03f\"\r\n| project Resource = tolower(extract(\"([\\\\s\\\\S]*?)(/providers/Microsoft.Security.*)\",1,id)), ResourceGroup = trim_end(\"/\",extract(\".*resourceGroups/(.+?)/\",0,id)), ResourceType = tolower(split(id,\"/\").[6]), subscriptionId, status = tostring(parse_json(properties).status.code), VulnId = tostring(parse_json(properties).id), description = tostring(parse_json(properties).displayName), cve = parse_json(properties.additionalData).cve, SoftwareVendor = tostring(properties.additionalData.softwareVendor), SoftwareName = tostring(properties.additionalData.softwareName), SoftwareVersion = tostring(properties.additionalData.softwareVersion), Source = tostring(properties.additionalData.source)\r\n| where status == 'Unhealthy'\r\n| summarize dcount(VulnId) by ResourceGroup, Resource, VulnId, description, tostring(cve), SoftwareVendor, SoftwareName, SoftwareVersion\r\n| mvexpand todynamic(cve)\r\n| extend CVEs = parse_json(cve['title'])\r\n| summarize CVEs = tostring(make_list(CVEs)), CVECount = count(CVEs) by Resource, ResourceGroup, VulnId, description, SoftwareVendor, SoftwareName, SoftwareVersion\r\n| where CVEs contains \"CVE-2022-29149\"\r\n| order by Resource",
                  "size": 3,
                  "showAnalytics": true,
                  "title": "Machines affected by OMI CVE ",
                  "noDataMessage": "No unhealthy machines found",
                  "exportFieldName": "Resource",
                  "exportParameterName": "selectedsrvitem",
                  "exportDefaultValue": "All",
                  "showExportToExcel": true,
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources",
                  "crossComponentResources": [
                    "{Subscription}"
                  ],
                  "visualization": "table",
                  "gridSettings": {
                    "formatters": [
                      {
                        "columnMatch": "Resource",
                        "formatter": 0,
                        "formatOptions": {
                          "customColumnWidthSetting": "25ch"
                        }
                      },
                      {
                        "columnMatch": "ResourceGroup",
                        "formatter": 0,
                        "formatOptions": {
                          "customColumnWidthSetting": "25ch"
                        }
                      },
                      {
                        "columnMatch": "VulnId",
                        "formatter": 0,
                        "formatOptions": {
                          "customColumnWidthSetting": "12ch"
                        }
                      },
                      {
                        "columnMatch": "description",
                        "formatter": 0,
                        "formatOptions": {
                          "customColumnWidthSetting": "40ch"
                        }
                      },
                      {
                        "columnMatch": "SoftwareVendor",
                        "formatter": 18,
                        "formatOptions": {
                          "thresholdsOptions": "icons",
                          "thresholdsGrid": [
                            {
                              "operator": "!=",
                              "thresholdValue": "microsoft",
                              "representation": "Blank",
                              "text": "N/A"
                            },
                            {
                              "operator": "Default",
                              "thresholdValue": null,
                              "representation": "Blank",
                              "text": "{0}{1}"
                            }
                          ],
                          "customColumnWidthSetting": "20ch"
                        }
                      },
                      {
                        "columnMatch": "SoftwareName",
                        "formatter": 18,
                        "formatOptions": {
                          "thresholdsOptions": "icons",
                          "thresholdsGrid": [
                            {
                              "operator": "is Empty",
                              "thresholdValue": "omi,oms",
                              "representation": "Blank",
                              "text": "{0}N/A"
                            },
                            {
                              "operator": "Default",
                              "thresholdValue": null,
                              "representation": "Blank",
                              "text": "{0}{1}"
                            }
                          ]
                        }
                      },
                      {
                        "columnMatch": "SoftwareVersion",
                        "formatter": 18,
                        "formatOptions": {
                          "thresholdsOptions": "icons",
                          "thresholdsGrid": [
                            {
                              "operator": "is Empty",
                              "representation": "Blank",
                              "text": "N/A"
                            },
                            {
                              "operator": "Default",
                              "thresholdValue": null,
                              "representation": "Blank",
                              "text": "{0}{1}"
                            }
                          ],
                          "customColumnWidthSetting": "25ch"
                        }
                      },
                      {
                        "columnMatch": "CVEs",
                        "formatter": 0,
                        "formatOptions": {
                          "customColumnWidthSetting": "70ch"
                        }
                      },
                      {
                        "columnMatch": "CVECount",
                        "formatter": 5
                      }
                    ],
                    "filter": true,
                    "sortBy": [
                      {
                        "itemKey": "$gen_thresholds_SoftwareVendor_4",
                        "sortOrder": 2
                      }
                    ],
                    "labelSettings": [
                      {
                        "columnId": "Resource",
                        "label": "Machine"
                      },
                      {
                        "columnId": "ResourceGroup",
                        "label": "Resource group"
                      },
                      {
                        "columnId": "VulnId",
                        "label": "Vuln ID"
                      },
                      {
                        "columnId": "description",
                        "label": "Description"
                      },
                      {
                        "columnId": "SoftwareVendor",
                        "label": "Software vendor"
                      },
                      {
                        "columnId": "SoftwareName",
                        "label": "Software name"
                      },
                      {
                        "columnId": "SoftwareVersion",
                        "label": "Software version"
                      },
                      {
                        "columnId": "CVEs",
                        "label": "CVEs "
                      }
                    ]
                  },
                  "sortBy": [
                    {
                      "itemKey": "$gen_thresholds_SoftwareVendor_4",
                      "sortOrder": 2
                    }
                  ]
                },
                "name": "TVM"
              }
            ]
          },
          "name": "Machines"
        }
      ],
      "isLocked": false,
      "fallbackResourceIds": [
        "azure security center"
      ],
      "fromTemplateId": "community-Workbooks/Azure Security Center/Log4j"
    }
  },
  "resources": [
    {
      "name": "[parameters('workbookId')]",
      "type": "microsoft.insights/workbooks",
      "location": "[resourceGroup().location]",
      "apiVersion": "2021-03-08",
      "dependsOn": [],
      "kind": "shared",
      "properties": {
        "displayName": "[parameters('workbookDisplayName')]",
        "serializedData": "[string(variables('workbookContent'))]",
        "version": "1.0",
        "sourceId": "[parameters('workbookSourceId')]",
        "category": "[parameters('workbookType')]"
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[resourceId( 'microsoft.insights/workbooks', parameters('workbookId'))]"
    }
  },
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#"
}
